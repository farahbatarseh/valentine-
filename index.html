<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Will you be my Valentine? üíò</title>

  <style>
    :root{
      --bg1:#ff7aa2;
      --bg2:#ffd1dc;
      --card:#ffffffcc;
      --text:#1f1f1f;
      --yes:#23c483;
      --no:#ff4d6d;
      --shadow: 0 20px 60px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 10%, #fff6, transparent 60%),
        radial-gradient(900px 700px at 90% 20%, #fff4, transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .hearts{
      position:fixed; inset:0; pointer-events:none; opacity:.18;
      background-image:
        radial-gradient(circle at 20% 30%, #fff 0 2px, transparent 3px),
        radial-gradient(circle at 80% 20%, #fff 0 2px, transparent 3px),
        radial-gradient(circle at 70% 80%, #fff 0 2px, transparent 3px),
        radial-gradient(circle at 40% 75%, #fff 0 2px, transparent 3px);
      filter: blur(.2px);
    }

    .screen{
      position:fixed; inset:0;
      display:none;
      place-items:center;
      padding:16px;
    }
    .screen.show{display:grid}

    .card{
      width:min(920px, 94vw);
      background:var(--card);
      border:1px solid #ffffff88;
      backdrop-filter: blur(10px);
      border-radius:28px;
      padding:22px 18px 18px;
      box-shadow:var(--shadow);
      position:relative;
    }

    .title{
      font-size:clamp(22px, 4.2vw, 44px);
      line-height:1.05;
      margin:0;
    }
    .subtitle{
      margin:10px 0 0;
      font-size:clamp(13px, 2.2vw, 18px);
      opacity:.88;
    }
    .subtitle .tease{
      display:inline-block;
      margin-top:6px;
      font-weight:900;
      opacity:.95;
    }

    .badge{
      padding:10px 14px;
      background:#fff;
      border-radius:999px;
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
      border:1px solid #00000010;
      font-weight:800;
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
      white-space:nowrap;
    }
    .rowTop{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#fff;
      border:1px solid #00000018;
      box-shadow: 0 18px 45px rgba(0,0,0,.18);
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      max-width:min(92vw, 560px);
      text-align:center;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:120;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }

    /* Buttons (shared) */
    .btn{
      border:none;
      padding:12px 14px;
      border-radius:14px;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      user-select:none;
      touch-action: manipulation;
    }
    .btnDark{ background:#111; color:#fff; }
    .btnLight{ background:#fff; color:#111; border:1px solid #00000014; }
    .btnGreen{
      background: linear-gradient(180deg, #2de7a0, #23c483);
      color:#083a26;
    }

    /* ====== GAME SCREEN ====== */
    #gameCard{ overflow:hidden; }
    .gameArea{
      margin-top:14px;
      height:min(520px, 62vh);
      border-radius:22px;
      border:1px dashed #00000025;
      background:
        radial-gradient(900px 600px at 20% 30%, #ffffffbb, transparent 55%),
        radial-gradient(900px 600px at 90% 80%, #ffffff88, transparent 55%),
        linear-gradient(180deg, #ffffffa8, #ffffff66);
      position:relative;
      overflow:hidden;
      touch-action: manipulation;
    }
    .gameHud{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .hint{
      opacity:.85;
      font-size:13px;
    }

    .bird{
      position:absolute;
      width:78px;
      height:56px;
      display:grid;
      place-items:center;
      font-size:40px;
      filter: drop-shadow(0 14px 20px rgba(0,0,0,.18));
      user-select:none;
      transform: translate(-9999px, -9999px);
      cursor:pointer;
      touch-action: manipulation;
    }
    .birdBubble{
      position:absolute;
      right:-6px;
      top:-10px;
      background:#fff;
      border:1px solid #00000018;
      border-radius:999px;
      padding:4px 8px;
      font-size:12px;
      font-weight:900;
      opacity:.9;
    }
    .progressBarWrap{
      height:12px;
      border-radius:999px;
      background:#ffffffb5;
      border:1px solid #00000012;
      overflow:hidden;
      flex: 1 1 260px;
      min-width:220px;
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #2de7a0, #23c483);
      border-radius:999px;
      transition: width .25s ease;
    }

    /* ====== PRANK SCREEN ====== */
    .arena{
      margin-top:16px;
      height:min(520px, 62vh);
      border-radius:22px;
      border:1px dashed #00000025;
      background: linear-gradient(180deg, #ffffffa8, #ffffff66);
      position:relative;
      overflow:hidden;
      touch-action: manipulation;
    }

    .stickers{ position:absolute; inset:0; pointer-events:none; }
    .sticker{
      position:absolute;
      width:110px;
      height:110px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.18));
      opacity:0;
      transition: opacity .25s ease, transform .25s ease;
      transform: scale(.95) rotate(var(--rot, 0deg));
    }
    .sticker.show{
      opacity:1;
      transform: scale(1) rotate(var(--rot, 0deg));
    }

    /* Prank buttons */
    .prankBtn{
      border:none;
      padding:16px 22px;
      border-radius:18px;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 12px 28px rgba(0,0,0,.18);
      transition: transform .08s ease;
      user-select:none;
      touch-action: manipulation;
    }
    .prankBtn:active{transform: scale(.98)}

    #yesBtn{
      background: linear-gradient(180deg, #2de7a0, #23c483);
      color:#083a26;
      min-width:210px;
      position:absolute;
      left:50%;
      top:78%;
      transform: translate(-50%, -50%);
      z-index:3;
    }
    #noBtn{
      background: linear-gradient(180deg, #ff7a92, #ff4d6d);
      color:#3b0610;
      min-width:180px;
      position:absolute;
      left:56%;
      top:56%;
      z-index:4;
    }

    .status{
      margin:14px 2px 0;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      font-size:14px;
      opacity:.92;
      align-items:center;
    }
    .msg{
      margin-top:10px;
      padding:12px 14px;
      border-radius:14px;
      background:#ffffffb3;
      border:1px solid #00000010;
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
      min-height:48px;
      font-size:15px;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:200;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(720px, 96vw);
      background:#fff;
      border-radius:26px;
      box-shadow: 0 25px 90px rgba(0,0,0,.35);
      padding:22px;
      position:relative;
      overflow:hidden;
    }
    .modalCard h2{
      margin:0;
      font-size:clamp(24px, 3.6vw, 40px);
    }
    .modalCard p{
      font-size:17px;
      line-height:1.35;
      margin:10px 0 0;
    }
    .kiss{font-size:44px;margin-top:10px;}
    .closeRow{
      margin-top:16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Confetti */
    #confetti{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:210;
    }
  </style>
</head>

<body>
  <canvas id="confetti"></canvas>
  <div class="hearts"></div>
  <div class="toast" id="toast"></div>

  <!-- ======= GAME SCREEN ======= -->
  <section class="screen show" id="gameScreen">
    <div class="card" id="gameCard">
      <div class="rowTop">
        <div>
          <h1 class="title">Mini game for Katia üíò</h1>
          <p class="subtitle">
            Tap the flying bird üê¶ to ‚Äúcatch love points‚Äù. Reach <b>5</b> hits to unlock the Valentine question üòà
          </p>
        </div>
        <div class="badge">üéØ Hits: <span id="hits">0</span>/5</div>
      </div>

      <div class="gameArea" id="gameArea">
        <div class="bird" id="bird" aria-label="bird">
          üê¶
          <div class="birdBubble" id="birdBubble">tap me</div>
        </div>
      </div>

      <div class="gameHud">
        <div class="progressBarWrap" aria-label="progress">
          <div class="progressBar" id="progressBar"></div>
        </div>
        <div class="hint">iPhone tip: just tap the bird. No dragging. ‚úÖ</div>
        <button class="btn btnDark" id="startGameBtn">Start</button>
        <button class="btn btnLight" id="skipBtn" title="Skip the game (if you're nice)">Skip</button>
      </div>
    </div>
  </section>

  <!-- ======= PRANK SCREEN ======= -->
  <section class="screen" id="prankScreen">
    <div class="card">
      <div class="rowTop">
        <div>
          <h1 class="title">Katia (Katkooteh)‚Ä¶ üíò<br>Will you be my Valentine?</h1>
          <p class="subtitle">
            From <b>Farah</b> ‚Äî choose wisely. (Your ‚ÄúNo‚Äù has legs today.)<br>
            <span class="tease">üòà If you can press NO then there is an extra game‚Ä¶</span>
          </p>
        </div>
        <div class="badge" title="Chase counter">üèÉ‚Äç‚ôÄÔ∏èüí® No-chases: <span id="chaseCount">0</span></div>
      </div>

      <div class="arena" id="arena">
        <div class="stickers" id="stickers"></div>
        <button class="prankBtn" id="yesBtn">YES üíçüíñ</button>
        <button class="prankBtn" id="noBtn">No üôÖ‚Äç‚ôÄÔ∏è</button>
      </div>

      <div class="status">
        <div>Difficulty: <b id="difficulty">Normal</b></div>
        <div>Hint: the ‚ÄúNo‚Äù button is in ‚ú®sport mode‚ú®</div>
      </div>

      <div class="msg" id="msg">üòá Come on Katkooteh‚Ä¶ it‚Äôs just a tiny YES. No pressure. (Okay maybe 1% pressure.)</div>
    </div>
  </section>

  <!-- YES modal -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <h2>LET‚ÄôS GOOOOOO üíò</h2>
      <p id="finalNote"></p>
      <div class="kiss">üòòüíûü•∞</div>
      <div class="closeRow">
        <button class="btn btnGreen" id="shareBtn">Share / Copy link</button>
        <button class="btn btnDark" id="closeBtn">Close</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ========= Custom names =========
  const FROM_NAME = "Farah";
  const TO_NAME_1 = "Katia";
  const TO_NICK = "Katkooteh";

  // ========= Screens =========
  const gameScreen = document.getElementById("gameScreen");
  const prankScreen = document.getElementById("prankScreen");

  // ========= Toast =========
  const toast = document.getElementById("toast");
  let toastTimer = null;
  function showToast(text, ms=1100){
    clearTimeout(toastTimer);
    toast.textContent = text;
    toast.classList.add("show");
    toastTimer = setTimeout(()=>toast.classList.remove("show"), ms);
  }

  // ========= Helpers =========
  function rand(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
  function dist(x1,y1,x2,y2){ return Math.hypot(x1-x2, y1-y2); }

  // ========= Sound (Web Audio, iPhone-safe after user gesture) =========
  let audioCtx = null;
  function ensureAudio(){
    if (!audioCtx){
      const Ctx = window.AudioContext || window.webkitAudioContext;
      audioCtx = Ctx ? new Ctx() : null;
    }
    // iOS sometimes starts suspended
    if (audioCtx && audioCtx.state === "suspended"){
      audioCtx.resume().catch(()=>{});
    }
  }
  function beep({freq=660, dur=0.07, type="sine", gain=0.06} = {}){
    if (!audioCtx) return;
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);

    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

    osc.connect(g);
    g.connect(audioCtx.destination);
    osc.start(t0);
    osc.stop(t0 + dur + 0.02);
  }
  function sfxHit(){
    beep({freq: 880, dur: 0.06, type:"triangle", gain:0.08});
    setTimeout(()=>beep({freq: 660, dur: 0.06, type:"triangle", gain:0.07}), 60);
  }
  function sfxNo(){
    beep({freq: 240, dur: 0.08, type:"square", gain:0.05});
    setTimeout(()=>beep({freq: 180, dur: 0.09, type:"square", gain:0.05}), 70);
  }
  function sfxYes(){
    beep({freq: 660, dur: 0.07, type:"sine", gain:0.07});
    setTimeout(()=>beep({freq: 880, dur: 0.09, type:"sine", gain:0.08}), 70);
    setTimeout(()=>beep({freq: 990, dur: 0.11, type:"sine", gain:0.08}), 150);
  }

  // ========= STAGE 1: Tap bird mini game (mobile friendly) =========
  const gameArea = document.getElementById("gameArea");
  const bird = document.getElementById("bird");
  const birdBubble = document.getElementById("birdBubble");
  const hitsEl = document.getElementById("hits");
  const progressBar = document.getElementById("progressBar");
  const startGameBtn = document.getElementById("startGameBtn");
  const skipBtn = document.getElementById("skipBtn");

  const romanticLines = [
    `üíò ${TO_NICK}, you just hit my heart.`,
    `ü•∞ Okay wow‚Ä¶ you‚Äôre kinda good at this.`,
    `‚ú® Farah approves this level of cuteness.`,
    `üíû That tap was‚Ä¶ dangerously adorable.`,
    `üòà One more and you unlock the question‚Ä¶`,
    `üíï If love had a score‚Ä¶ you‚Äôre winning.`,
    `üåπ This is your ‚Äúromance accuracy‚Äù test.`,
    `üòò Tap again and I might blush IRL.`,
  ];

  let hits = 0;
  let gameRunning = false;
  let raf = null;

  const birdState = {
    x: 0, y: 0,
    vx: 2.2, vy: 1.2,
    wobble: 0,
    lastTs: 0
  };

  function placeBirdInitial(){
    const r = gameArea.getBoundingClientRect();
    birdState.x = Math.max(10, r.width * 0.15);
    birdState.y = Math.max(10, r.height * 0.35);
    bird.style.transform = `translate(${birdState.x}px, ${birdState.y}px)`;
  }

  function startGame(){
    ensureAudio();
    hits = 0;
    hitsEl.textContent = String(hits);
    progressBar.style.width = "0%";
    birdBubble.textContent = "tap me";
    showToast("üê¶ Ready? Tap the bird!", 1000);

    birdState.vx = 2.4;
    birdState.vy = 1.3;
    birdState.wobble = 0;
    birdState.lastTs = performance.now();

    placeBirdInitial();
    gameRunning = true;
    startGameBtn.textContent = "Restart";
    if (raf) cancelAnimationFrame(raf);
    raf = requestAnimationFrame(loopGame);
  }

  function endGameAndGoToPrank(){
    ensureAudio();
    gameRunning = false;
    if (raf) cancelAnimationFrame(raf);

    showToast("‚úÖ Unlocked! Welcome to the real question üòà", 1200);
    setTimeout(() => {
      gameScreen.classList.remove("show");
      prankScreen.classList.add("show");
      initPrank();
      showToast("üòà Try clicking NO for an extra game‚Ä¶", 1400);
    }, 900);
  }

  function loopGame(ts){
    if (!gameRunning) return;

    const r = gameArea.getBoundingClientRect();
    const w = 78, h = 56;
    const dt = Math.min(32, ts - birdState.lastTs);
    birdState.lastTs = ts;

    birdState.x += birdState.vx * (dt/16);
    birdState.y += birdState.vy * (dt/16);

    birdState.wobble += 0.08 * (dt/16);
    const wob = Math.sin(birdState.wobble) * 8;

    const pad = 6;
    if (birdState.x < pad) { birdState.x = pad; birdState.vx *= -1; }
    if (birdState.x > r.width - w - pad) { birdState.x = r.width - w - pad; birdState.vx *= -1; }
    if (birdState.y < pad) { birdState.y = pad; birdState.vy *= -1; }
    if (birdState.y > r.height - h - pad) { birdState.y = r.height - h - pad; birdState.vy *= -1; }

    bird.style.transform = `translate(${birdState.x}px, ${birdState.y + wob}px)`;
    raf = requestAnimationFrame(loopGame);
  }

  function onBirdHit(e){
    e.preventDefault();
    ensureAudio();
    if (!gameRunning) return;

    hits = Math.min(5, hits + 1);
    hitsEl.textContent = String(hits);
    progressBar.style.width = `${(hits/5)*100}%`;

    sfxHit();

    birdState.vx = (birdState.vx > 0 ? 1 : -1) * (2.8 + hits*0.35);
    birdState.vy = (birdState.vy > 0 ? 1 : -1) * (1.6 + hits*0.28);

    showToast(romanticLines[rand(0, romanticLines.length-1)], 1100);

    if (hits >= 5){
      showToast(`üíò ${TO_NICK} unlocked it‚Ä¶ now face the YES üòà`, 1400);
      setTimeout(endGameAndGoToPrank, 650);
    }
  }

  startGameBtn.addEventListener("click", startGame);
  skipBtn.addEventListener("click", endGameAndGoToPrank);

  bird.addEventListener("touchstart", onBirdHit, {passive:false});
  bird.addEventListener("click", onBirdHit);

  window.addEventListener("resize", () => {
    if (!prankScreen.classList.contains("show")) placeBirdInitial();
  });
  placeBirdInitial();

  // ========= STAGE 2: Valentine prank =========
  const arena = document.getElementById("arena");
  const noBtn = document.getElementById("noBtn");
  const yesBtn = document.getElementById("yesBtn");
  const msg = document.getElementById("msg");
  const chaseCountEl = document.getElementById("chaseCount");
  const diffEl = document.getElementById("difficulty");
  const stickersEl = document.getElementById("stickers");
  const modal = document.getElementById("modal");
  const finalNote = document.getElementById("finalNote");
  const closeBtn = document.getElementById("closeBtn");
  const shareBtn = document.getElementById("shareBtn");

  const messages = [
    `üòá Come on ${TO_NICK}‚Ä¶ it‚Äôs just a tiny YES. No pressure. (Okay maybe 1% pressure.)`,
    `üòè The ‚ÄúNo‚Äù button said: ‚ÄúCatch me if you can, ${TO_NAME_1}.‚Äù`,
    `üèÉ‚Äç‚ôÄÔ∏èüí® Plot twist: ‚ÄúNo‚Äù is training for the Olympics.`,
    `üòà ${FROM_NAME} installed anti-No technology. It‚Äôs‚Ä¶ working.`,
    `üòÇ The ‚ÄúNo‚Äù button is basically: *404: Confidence not found*`,
    `üß† Strategy tip: Try approaching from the left. (The No button can smell fear.)`,
    `ü•∑ The ‚ÄúNo‚Äù button activated stealth mode.`,
    `üòµ‚Äçüí´ ${TO_NICK}, at this point you‚Äôre doing cardio for love.`,
    `ü§ù Deal: click YES and I‚Äôll pretend this never happened.`,
    `üíò The universe is begging you. Also me. Mostly me.`,
  ];

  const svgSticker = (emoji, label) => {
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="220" height="220">
  <defs>
    <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0" stop-color="#ffffff"/>
      <stop offset="1" stop-color="#ffe3ee"/>
    </linearGradient>
  </defs>
  <rect x="10" y="10" width="200" height="200" rx="34" fill="url(#g)" stroke="#00000022" stroke-width="4"/>
  <text x="110" y="115" text-anchor="middle" dominant-baseline="middle" font-size="88">${emoji}</text>
  <text x="110" y="175" text-anchor="middle" font-family="ui-sans-serif,system-ui,Segoe UI" font-size="18" font-weight="900" fill="#111">${label}</text>
</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  };

  const stickers = [
    { src: svgSticker("ü´∂", "LOVE DETECTED"), label: "Love detected" },
    { src: svgSticker("üòÇ", "NOPE RUNNING"), label: "Nope running" },
    { src: svgSticker("üèÉ‚Äç‚ôÄÔ∏è", "CARDIO MODE"), label: "Cardio mode" },
    { src: svgSticker("ü•∑", "STEALTH NO"), label: "Stealth no" },
    { src: svgSticker("üíò", "JUST SAY YES"), label: "Just say yes" },
    { src: svgSticker("üòà", "FARAH'S PLAN"), label: "Farah‚Äôs plan" },
    { src: svgSticker("üß†", "TRY HARDER"), label: "Try harder" },
    { src: svgSticker("üê£", "CUTENESS"), label: "Cuteness overload" },
    { src: svgSticker("üç´", "BRIBE?"), label: "Bribe incoming" },
  ];

  let stickerNodes = [];
  let chases = 0;
  let lastTeleport = 0;

  function getDifficulty(){
    if (chases < 4) return { name:"Normal", dodgeRadius: 95, cooldown: 90 };
    if (chases < 8) return { name:"Spicy", dodgeRadius: 125, cooldown: 70 };
    return { name:"Demon Mode", dodgeRadius: 165, cooldown: 55 };
  }

  function setMessage(){
    msg.textContent = messages[Math.min(chases, messages.length - 1)];
  }

  function showSticker(){
    const index = Math.min(Math.floor(chases / 1.4), stickerNodes.length - 1);
    const node = stickerNodes[index];
    if (!node) return;

    const pad = 10;
    const w = 110, h = 110;
    const rect = arena.getBoundingClientRect();
    const maxX = rect.width - w - pad;
    const maxY = rect.height - h - pad;

    node.style.left = `${rand(pad, Math.max(pad, maxX))}px`;
    node.style.top  = `${rand(pad, Math.max(pad, maxY))}px`;
    node.classList.add("show");
  }

  function teleportYes(){
    const arenaRect = arena.getBoundingClientRect();
    const btnW = Math.max(yesBtn.offsetWidth, 210);
    const btnH = Math.max(yesBtn.offsetHeight, 56);
    const pad = 18;

    const maxX = arenaRect.width - btnW - pad;
    const maxY = arenaRect.height - btnH - pad;

    const noX = noBtn.offsetLeft + noBtn.offsetWidth / 2;
    const noY = noBtn.offsetTop  + noBtn.offsetHeight / 2;

    const minY = Math.max(pad, Math.floor(arenaRect.height * 0.30));
    const maxY2 = Math.max(minY, Math.min(maxY, Math.floor(arenaRect.height * 0.88)));

    let x, y, tries = 0;
    do{
      x = rand(pad, Math.max(pad, maxX));
      y = rand(minY, maxY2);
      tries++;
      if (tries > 60) break;
    } while (dist(x + btnW/2, y + btnH/2, noX, noY) < 150);

    yesBtn.style.left = `${x + btnW/2}px`;
    yesBtn.style.top  = `${y + btnH/2}px`;
  }

  function teleportNo(reason=""){
    const now = performance.now();
    const diff = getDifficulty();
    if (now - lastTeleport < diff.cooldown) return;
    lastTeleport = now;

    chases++;
    chaseCountEl.textContent = String(chases);
    diffEl.textContent = diff.name;

    setMessage();
    showSticker();
    teleportYes();
    sfxNo();

    const arenaRect = arena.getBoundingClientRect();
    const btnW = Math.max(noBtn.offsetWidth, 180);
    const btnH = Math.max(noBtn.offsetHeight, 56);

    const pad = 18;
    const maxX = arenaRect.width - btnW - pad;
    const maxY = arenaRect.height - btnH - pad;

    let x, y, tries = 0;
    do{
      x = rand(pad, Math.max(pad, maxX));
      y = rand(pad, Math.max(pad, maxY));
      tries++;
      if (tries > 70) break;
    } while (dist(x + btnW/2, y + btnH/2, parseFloat(yesBtn.style.left||0), parseFloat(yesBtn.style.top||0)) < 140);

    noBtn.style.left = `${x}px`;
    noBtn.style.top  = `${y}px`;
  }

  function initPrank(){
    if (stickerNodes.length === 0){
      stickerNodes = stickers.map((s) => {
        const img = document.createElement("img");
        img.className = "sticker";
        img.src = s.src;
        img.alt = s.label;
        img.style.setProperty("--rot", `${rand(-18, 18)}deg`);
        stickersEl.appendChild(img);
        return img;
      });
    }

    chases = 0;
    chaseCountEl.textContent = "0";
    diffEl.textContent = "Normal";
    setMessage();

    requestAnimationFrame(() => {
      teleportYes();
      teleportNo("init");
    });
  }

  // iPhone: dodge based on finger proximity
  arena.addEventListener("touchmove", (e) => {
    const t = e.touches && e.touches[0];
    if (!t) return;
    const diff = getDifficulty();
    const rect = arena.getBoundingClientRect();
    const mx = t.clientX - rect.left;
    const my = t.clientY - rect.top;

    const bx = noBtn.offsetLeft + noBtn.offsetWidth / 2;
    const by = noBtn.offsetTop  + noBtn.offsetHeight / 2;

    if (dist(mx, my, bx, by) < diff.dodgeRadius) teleportNo("near");
  }, {passive:true});

  arena.addEventListener("touchstart", (e) => {
    ensureAudio();
    const t = e.touches && e.touches[0];
    if (!t) return;

    const diff = getDifficulty();
    const rect = arena.getBoundingClientRect();
    const mx = t.clientX - rect.left;
    const my = t.clientY - rect.top;

    const bx = noBtn.offsetLeft + noBtn.offsetWidth / 2;
    const by = noBtn.offsetTop  + noBtn.offsetHeight / 2;

    if (dist(mx, my, bx, by) < diff.dodgeRadius + 10) teleportNo("near");
  }, {passive:true});

  noBtn.addEventListener("touchstart", (e) => {
    e.preventDefault();
    ensureAudio();
    teleportNo("touch");
    showToast("üòà Nice try. Almost unlocked the ‚Äòextra game‚Äô‚Ä¶", 950);
  }, {passive:false});

  // Desktop fallback
  arena.addEventListener("mousemove", (e) => {
    const diff = getDifficulty();
    const rect = arena.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const bx = noBtn.offsetLeft + noBtn.offsetWidth / 2;
    const by = noBtn.offsetTop  + noBtn.offsetHeight / 2;

    if (dist(mx, my, bx, by) < diff.dodgeRadius) teleportNo("near");
  });

  noBtn.addEventListener("mouseenter", () => teleportNo("hover"));

  // YES click success
  yesBtn.addEventListener("click", () => {
    ensureAudio();
    sfxYes();

    const extra = chases === 0
      ? `You didn‚Äôt even chase the No button‚Ä¶ suspiciously mature. üòå`
      : `Also: you chased the No button <b>${chases}</b> times. That‚Äôs true love cardio. üèÉ‚Äç‚ôÄÔ∏èüíò`;

    finalNote.innerHTML =
      `Dear <b>${TO_NAME_1}</b> / <b>${TO_NICK}</b>,<br><br>
      THANK YOU for clicking <b>YES</b> üò≠üíñ<br>
      I officially declare you my Valentine (and the winner of this very serious competition).<br><br>
      ${extra}<br><br>
      <b>Now screenshot this and send it to ${FROM_NAME} üòàüì∏</b><br><br>
      Love,<br><b>${FROM_NAME}</b> ‚ù§Ô∏è`;

    modal.classList.add("show");
    startConfetti();
    showToast("üì∏ Screenshot time üòà", 1400);
  });

  // Share button: iPhone share sheet if available, else copy link
  shareBtn.addEventListener("click", async () => {
    ensureAudio();
    const url = window.location.href;
    const text = `üòÇ ${TO_NICK} finally clicked YES! Send this to ${FROM_NAME}:`;

    try{
      if (navigator.share){
        await navigator.share({ title: "Valentine Prank üíò", text, url });
        showToast("‚úÖ Shared!", 900);
      } else {
        await navigator.clipboard.writeText(url);
        showToast("‚úÖ Link copied! Paste it to Farah üòà", 1200);
      }
    } catch (err){
      // fallback copy if share cancelled or blocked
      try{
        await navigator.clipboard.writeText(url);
        showToast("‚úÖ Link copied! Paste it to Farah üòà", 1200);
      } catch {
        showToast("Copy failed üò≠ Just copy the URL from the address bar.", 1500);
      }
    }
  });

  closeBtn.addEventListener("click", () => {
    modal.classList.remove("show");
    stopConfetti();
  });
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.remove("show");
      stopConfetti();
    }
  });

  // ========= Confetti =========
  const canvas = document.getElementById("confetti");
  const ctx = canvas.getContext("2d");
  let confettiOn = false;
  let particles = [];
  let rafId = null;

  function resize(){
    canvas.width = window.innerWidth * devicePixelRatio;
    canvas.height = window.innerHeight * devicePixelRatio;
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  function startConfetti(){
    confettiOn = true;
    particles = Array.from({length: 220}, () => ({
      x: Math.random() * window.innerWidth,
      y: -20 - Math.random() * window.innerHeight,
      r: 4 + Math.random() * 6,
      vx: -2 + Math.random() * 4,
      vy: 2 + Math.random() * 5,
      rot: Math.random() * Math.PI,
      vr: -0.2 + Math.random() * 0.4,
      hue: Math.random() * 360
    }));
    if (!rafId) loop();
  }

  function stopConfetti(){
    confettiOn = false;
    particles = [];
    if (rafId){
      cancelAnimationFrame(rafId);
      rafId = null;
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    }
  }

  function loop(){
    rafId = requestAnimationFrame(loop);
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

    for (const p of particles){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;

      if (p.y > window.innerHeight + 30){
        p.y = -20;
        p.x = Math.random() * window.innerWidth;
      }
      if (p.x < -30) p.x = window.innerWidth + 30;
      if (p.x > window.innerWidth + 30) p.x = -30;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = `hsl(${p.hue}, 90%, 60%)`;
      ctx.fillRect(-p.r, -p.r/2, p.r*2, p.r);
      ctx.restore();
    }

    if (!confettiOn) stopConfetti();
  }
})();
</script>
</body>
</html>
